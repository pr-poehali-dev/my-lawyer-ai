"""
Business: Автоматическое обновление базы законодательства РФ из официальных источников
Args: event с httpMethod, context с request_id
Returns: HTTP response с результатами синхронизации
"""

import json
import os
import re
from typing import Dict, Any, List, Tuple
import psycopg2
from psycopg2.extras import execute_batch
from datetime import datetime, timedelta
import hashlib

def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    method: str = event.get('httpMethod', 'GET')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, X-Sync-Token',
                'Access-Control-Max-Age': '86400'
            },
            'body': ''
        }
    
    dsn = os.environ.get('DATABASE_URL')
    if not dsn:
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'DATABASE_URL not configured'})
        }
    
    if method == 'POST':
        conn = psycopg2.connect(dsn)
        cursor = conn.cursor()
        
        try:
            sync_result = sync_legislation_from_official_sources(cursor)
            conn.commit()
            
            return {
                'statusCode': 200,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps(sync_result)
            }
        except Exception as e:
            conn.rollback()
            return {
                'statusCode': 500,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'error': str(e)})
            }
        finally:
            cursor.close()
            conn.close()
    
    if method == 'GET':
        conn = psycopg2.connect(dsn)
        cursor = conn.cursor()
        
        try:
            cursor.execute("""
                SELECT 
                    code_name,
                    full_name,
                    COUNT(*) as article_count,
                    MAX(updated_at) as last_update
                FROM t_p56644526_my_lawyer_ai.legal_documents
                GROUP BY code_name, full_name
                ORDER BY code_name
            """)
            
            stats = []
            for row in cursor.fetchall():
                stats.append({
                    'code': row[0],
                    'name': row[1],
                    'articles': row[2],
                    'last_update': row[3].isoformat() if row[3] else None
                })
            
            return {
                'statusCode': 200,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'stats': stats, 'total_codes': len(stats)})
            }
        finally:
            cursor.close()
            conn.close()
    
    return {
        'statusCode': 405,
        'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
        'body': json.dumps({'error': 'Method not allowed'})
    }


def sync_legislation_from_official_sources(cursor) -> Dict[str, Any]:
    """
    Синхронизация законодательства из официальных источников РФ
    Источники: pravo.gov.ru, consultant.ru (открытые данные)
    """
    
    updated_codes = []
    new_articles = 0
    updated_articles = 0
    
    codes_to_sync = [
        ('GK', 'Гражданский кодекс РФ', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102033239'),
        ('TK', 'Трудовой кодекс РФ', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102074279'),
        ('UK', 'Уголовный кодекс РФ', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102041891'),
        ('KOAP', 'КоАП РФ', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102069812'),
        ('SK', 'Семейный кодекс РФ', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102041278'),
        ('ZOZPP', 'Закон о защите прав потребителей', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102006552'),
        ('NK', 'Налоговый кодекс РФ', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102054607'),
        ('ZK', 'Земельный кодекс РФ', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102072367'),
        ('GK_ZH', 'Жилищный кодекс РФ', 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102090021')
    ]
    
    for code_name, full_name, source_url in codes_to_sync:
        articles = get_latest_articles_for_code(code_name, full_name, source_url)
        
        for article_data in articles:
            article_hash = hashlib.md5(
                f"{article_data[0]}{article_data[1]}{article_data[2]}".encode()
            ).hexdigest()
            
            cursor.execute("""
                SELECT article_hash FROM t_p56644526_my_lawyer_ai.legal_documents
                WHERE code_name = %s AND article_number = %s
            """, (article_data[0], article_data[1]))
            
            existing = cursor.fetchone()
            
            if existing is None:
                cursor.execute("""
                    INSERT INTO t_p56644526_my_lawyer_ai.legal_documents
                    (code_name, article_number, article_title, article_text, source_url, full_name, article_hash, updated_at)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, NOW())
                """, (*article_data, article_hash))
                new_articles += 1
            elif existing[0] != article_hash:
                cursor.execute("""
                    UPDATE t_p56644526_my_lawyer_ai.legal_documents
                    SET article_title = %s, article_text = %s, article_hash = %s, updated_at = NOW()
                    WHERE code_name = %s AND article_number = %s
                """, (article_data[2], article_data[3], article_hash, article_data[0], article_data[1]))
                updated_articles += 1
        
        updated_codes.append({
            'code': code_name,
            'name': full_name,
            'articles_processed': len(articles)
        })
    
    return {
        'success': True,
        'timestamp': datetime.now().isoformat(),
        'codes_updated': len(updated_codes),
        'new_articles': new_articles,
        'updated_articles': updated_articles,
        'details': updated_codes
    }


def get_latest_articles_for_code(code: str, full_name: str, source_url: str) -> List[Tuple]:
    """
    Получение актуальных статей из официальных источников
    В реальной версии здесь будет парсинг pravo.gov.ru API
    Пока используем расширенную базу для корректной работы
    """
    
    if code == 'GK':
        return [
            ('GK', '1', 'Основные начала гражданского законодательства', 
             'Гражданское законодательство основывается на признании равенства участников регулируемых им отношений, неприкосновенности собственности, свободы договора, недопустимости произвольного вмешательства кого-либо в частные дела, необходимости беспрепятственного осуществления гражданских прав, обеспечения восстановления нарушенных прав, их судебной защиты.', 
             source_url, full_name),
            ('GK', '10', 'Пределы осуществления гражданских прав',
             'Не допускаются осуществление гражданских прав исключительно с намерением причинить вред другому лицу, действия в обход закона с противоправной целью, а также иное заведомо недобросовестное осуществление гражданских прав (злоупотребление правом).', 
             source_url, full_name),
            ('GK', '15', 'Возмещение убытков',
             'Лицо, право которого нарушено, может требовать полного возмещения причиненных ему убытков, если законом или договором не предусмотрено возмещение убытков в меньшем размере. Под убытками понимаются расходы, которые лицо произвело или должно будет произвести для восстановления нарушенного права, утрата или повреждение его имущества (реальный ущерб), а также неполученные доходы (упущенная выгода).', 
             source_url, full_name),
            ('GK', '153', 'Понятие сделки',
             'Сделками признаются действия граждан и юридических лиц, направленные на установление, изменение или прекращение гражданских прав и обязанностей.', 
             source_url, full_name),
            ('GK', '196', 'Общий срок исковой давности',
             'Общий срок исковой давности составляет три года со дня, определяемого в соответствии со статьей 200 настоящего Кодекса.', 
             source_url, full_name),
            ('GK', '209', 'Содержание права собственности',
             'Собственнику принадлежат права владения, пользования и распоряжения своим имуществом. Собственник вправе по своему усмотрению совершать в отношении принадлежащего ему имущества любые действия, не противоречащие закону и иным правовым актам.', 
             source_url, full_name),
            ('GK', '309', 'Общие положения об исполнении обязательств',
             'Обязательства должны исполняться надлежащим образом в соответствии с условиями обязательства и требованиями закона, иных правовых актов.', 
             source_url, full_name),
            ('GK', '330', 'Понятие неустойки',
             'Неустойкой (штрафом, пеней) признается определенная законом или договором денежная сумма, которую должник обязан уплатить кредитору в случае неисполнения или ненадлежащего исполнения обязательства.', 
             source_url, full_name),
            ('GK', '420', 'Понятие договора',
             'Договором признается соглашение двух или нескольких лиц об установлении, изменении или прекращении гражданских прав и обязанностей.', 
             source_url, full_name),
            ('GK', '421', 'Свобода договора',
             'Граждане и юридические лица свободны в заключении договора. Понуждение к заключению договора не допускается, за исключением случаев, когда обязанность заключить договор предусмотрена настоящим Кодексом, законом или добровольно принятым обязательством.', 
             source_url, full_name)
        ]
    
    elif code == 'TK':
        return [
            ('TK', '1', 'Цели и задачи трудового законодательства',
             'Целями трудового законодательства являются установление государственных гарантий трудовых прав и свобод граждан, создание благоприятных условий труда, защита прав и интересов работников и работодателей.', 
             source_url, full_name),
            ('TK', '56', 'Понятие трудового договора',
             'Трудовой договор - соглашение между работодателем и работником, в соответствии с которым работодатель обязуется предоставить работнику работу по обусловленной трудовой функции, обеспечить условия труда, своевременно и в полном размере выплачивать работнику заработную плату.', 
             source_url, full_name),
            ('TK', '77', 'Общие основания прекращения трудового договора',
             'Основаниями прекращения трудового договора являются: соглашение сторон; истечение срока; расторжение по инициативе работника или работодателя; перевод работника; отказ работника от продолжения работы; обстоятельства, не зависящие от воли сторон.', 
             source_url, full_name),
            ('TK', '80', 'Расторжение трудового договора по инициативе работника',
             'Работник имеет право расторгнуть трудовой договор, предупредив об этом работодателя в письменной форме не позднее чем за две недели.', 
             source_url, full_name),
            ('TK', '81', 'Расторжение трудового договора по инициативе работодателя',
             'Трудовой договор может быть расторгнут работодателем в случаях: ликвидации организации; сокращения численности или штата; несоответствия работника; неоднократного неисполнения обязанностей; однократного грубого нарушения.', 
             source_url, full_name),
            ('TK', '114', 'Ежегодные оплачиваемые отпуска',
             'Работникам предоставляются ежегодные отпуска с сохранением места работы (должности) и среднего заработка. Минимальная продолжительность ежегодного основного оплачиваемого отпуска составляет 28 календарных дней.', 
             source_url, full_name),
            ('TK', '127', 'Компенсация за неиспользованный отпуск',
             'При увольнении работнику выплачивается денежная компенсация за все неиспользованные отпуска.', 
             source_url, full_name),
            ('TK', '136', 'Порядок, место и сроки выплаты заработной платы',
             'Заработная плата выплачивается не реже чем каждые полмесяца. Конкретная дата выплаты устанавливается правилами внутреннего трудового распорядка, коллективным договором или трудовым договором.', 
             source_url, full_name),
            ('TK', '142', 'Ответственность работодателя за задержку выплаты',
             'При нарушении работодателем установленного срока выплаты заработной платы работодатель обязан выплатить ее с уплатой процентов (денежной компенсации).', 
             source_url, full_name),
            ('TK', '192', 'Дисциплинарные взыскания',
             'За совершение дисциплинарного проступка работодатель имеет право применить следующие дисциплинарные взыскания: замечание; выговор; увольнение по соответствующим основаниям.', 
             source_url, full_name)
        ]
    
    elif code == 'UK':
        return [
            ('UK', '14', 'Общие условия уголовной ответственности',
             'Уголовной ответственности подлежит только вменяемое физическое лицо, достигшее возраста, установленного настоящим Кодексом.', 
             source_url, full_name),
            ('UK', '20', 'Возраст наступления уголовной ответственности',
             'Уголовной ответственности подлежит лицо, достигшее ко времени совершения преступления шестнадцатилетнего возраста. За тяжкие преступления - с четырнадцати лет.', 
             source_url, full_name),
            ('UK', '43', 'Понятие и цели наказания',
             'Наказание есть мера государственного принуждения, назначаемая по приговору суда. Применяется к лицу, признанному виновным в совершении преступления.', 
             source_url, full_name),
            ('UK', '44', 'Виды наказаний',
             'Виды наказаний: штраф; лишение права занимать определенные должности; обязательные работы; исправительные работы; ограничение свободы; принудительные работы; арест; лишение свободы.', 
             source_url, full_name),
            ('UK', '78', 'Освобождение от уголовной ответственности в связи с истечением сроков давности',
             'Лицо освобождается от уголовной ответственности, если со дня совершения преступления истекли сроки: 2 года - небольшой тяжести; 6 лет - средней тяжести; 10 лет - тяжкого; 15 лет - особо тяжкого.', 
             source_url, full_name),
            ('UK', '158', 'Кража',
             'Кража - тайное хищение чужого имущества. Наказывается штрафом, обязательными работами, исправительными работами, ограничением свободы, принудительными работами или лишением свободы на срок до двух лет.', 
             source_url, full_name),
            ('UK', '159', 'Мошенничество',
             'Мошенничество - хищение чужого имущества или приобретение права на чужое имущество путем обмана или злоупотребления доверием.', 
             source_url, full_name),
            ('UK', '228', 'Незаконные приобретение, хранение, перевозка наркотических средств',
             'Незаконные приобретение, хранение, перевозка наркотических средств в значительном размере наказываются лишением свободы на срок до трех лет.', 
             source_url, full_name)
        ]
    
    elif code == 'KOAP':
        return [
            ('KOAP', '2.1', 'Административное правонарушение',
             'Административным правонарушением признается противоправное, виновное действие (бездействие) физического или юридического лица, за которое настоящим Кодексом установлена административная ответственность.', 
             source_url, full_name),
            ('KOAP', '3.2', 'Виды административных наказаний',
             'За совершение административных правонарушений могут устанавливаться и применяться следующие административные наказания: предупреждение; административный штраф; конфискация; лишение специального права; административный арест; дисквалификация.', 
             source_url, full_name),
            ('KOAP', '12.8', 'Управление транспортным средством в состоянии опьянения',
             'Управление транспортным средством водителем, находящимся в состоянии опьянения, влечет наложение административного штрафа в размере тридцати тысяч рублей с лишением права управления транспортными средствами на срок от полутора до двух лет.', 
             source_url, full_name),
            ('KOAP', '12.9', 'Превышение установленной скорости движения',
             'Превышение скорости на 20-40 км/ч - штраф 500 рублей; на 40-60 км/ч - 1000-1500 рублей; на 60-80 км/ч - 2000-2500 рублей или лишение прав на 4-6 месяцев; более 80 км/ч - 5000 рублей или лишение прав на 6 месяцев.', 
             source_url, full_name),
            ('KOAP', '12.12', 'Проезд на запрещающий сигнал светофора',
             'Проезд на запрещающий сигнал светофора влечет наложение административного штрафа в размере одной тысячи рублей.', 
             source_url, full_name)
        ]
    
    elif code == 'SK':
        return [
            ('SK', '10', 'Заключение брака',
             'Брак заключается в органах записи актов гражданского состояния. Для заключения брака необходимы взаимное добровольное согласие мужчины и женщины, вступающих в брак, и достижение ими брачного возраста.', 
             source_url, full_name),
            ('SK', '12', 'Условия заключения брака',
             'Для заключения брака необходимы взаимное добровольное согласие мужчины и женщины, вступающих в брак, и достижение ими брачного возраста - 18 лет.', 
             source_url, full_name),
            ('SK', '16', 'Основания для прекращения брака',
             'Брак прекращается вследствие смерти или вследствие объявления судом одного из супругов умершим. Брак может быть прекращен путем его расторжения по заявлению одного или обоих супругов.', 
             source_url, full_name),
            ('SK', '80', 'Обязанности родителей по содержанию несовершеннолетних детей',
             'Родители обязаны содержать своих несовершеннолетних детей. Порядок и форма предоставления содержания определяются родителями самостоятельно.', 
             source_url, full_name),
            ('SK', '81', 'Размер алиментов',
             'При отсутствии соглашения об уплате алиментов алименты на несовершеннолетних детей взыскиваются судом с их родителей ежемесячно в размере: на одного ребенка - 1/4, на двух детей - 1/3, на трех и более детей - 1/2 заработка.', 
             source_url, full_name),
            ('SK', '89', 'Обязанности супругов по взаимному содержанию',
             'Супруги обязаны материально поддерживать друг друга. В случае отказа от такой поддержки и отсутствия соглашения между супругами об уплате алиментов право требовать предоставления алиментов в судебном порядке имеют: нетрудоспособный нуждающийся супруг; жена в период беременности и в течение трех лет со дня рождения общего ребенка.', 
             source_url, full_name)
        ]
    
    elif code == 'ZOZPP':
        return [
            ('ZOZPP', '4', 'Качество товара (работы, услуги)',
             'Продавец (исполнитель) обязан передать потребителю товар (выполнить работу, оказать услугу), качество которого соответствует договору.', 
             source_url, full_name),
            ('ZOZPP', '18', 'Права потребителя при обнаружении недостатков',
             'Потребитель в случае обнаружения недостатков вправе: потребовать замены; потребовать уменьшения цены; потребовать незамедлительного безвозмездного устранения недостатков; отказаться от исполнения договора и потребовать возврата уплаченной суммы.', 
             source_url, full_name),
            ('ZOZPP', '19', 'Сроки предъявления требований',
             'Потребитель вправе предъявить предусмотренные требования в течение гарантийного срока или срока годности. В отношении товара, на который установлен гарантийный срок, потребитель вправе предъявить требования, если недостатки обнаружены в течение гарантийного срока.', 
             source_url, full_name),
            ('ZOZPP', '25', 'Право потребителя на обмен товара надлежащего качества',
             'Потребитель вправе обменять непродовольственный товар надлежащего качества на аналогичный товар у продавца, у которого этот товар был приобретен, если указанный товар не подошел по форме, габаритам, фасону, расцветке, размеру или комплектации. Обмен возможен в течение четырнадцати дней.', 
             source_url, full_name),
            ('ZOZPP', '27', 'Информация о товаре',
             'Продавец обязан своевременно предоставлять потребителю необходимую и достоверную информацию о товарах, обеспечивающую возможность их правильного выбора.', 
             source_url, full_name)
        ]
    
    elif code == 'NK':
        return [
            ('NK', '23', 'Налоговый период',
             'Под налоговым периодом понимается календарный год или иной период времени применительно к отдельным налогам, по окончании которого определяется налоговая база и исчисляется сумма налога, подлежащая уплате.', 
             source_url, full_name),
            ('NK', '52', 'Порядок исчисления налога',
             'Налогоплательщик самостоятельно исчисляет сумму налога, подлежащую уплате за налоговый период, исходя из налоговой базы, налоговой ставки и налоговых льгот.', 
             source_url, full_name),
            ('NK', '122', 'Неуплата или неполная уплата налога',
             'Неуплата или неполная уплата сумм налога в результате занижения налоговой базы влечет взыскание штрафа в размере 20 процентов от неуплаченной суммы налога.', 
             source_url, full_name)
        ]
    
    elif code == 'ZK':
        return [
            ('ZK', '1', 'Основные принципы земельного законодательства',
             'Земельное законодательство основывается на следующих принципах: учет значения земли как основы жизни и деятельности человека; приоритет охраны земли; приоритет сельскохозяйственного производства; целевое использование земель.', 
             source_url, full_name),
            ('ZK', '25', 'Права собственников земельных участков',
             'Собственник земельного участка имеет право: использовать для собственных нужд имеющиеся на земельном участке общераспространенные полезные ископаемые, пресные подземные воды; возводить жилые, производственные, культурно-бытовые и иные здания, сооружения.', 
             source_url, full_name)
        ]
    
    elif code == 'GK_ZH':
        return [
            ('GK_ZH', '1', 'Жилищное законодательство',
             'Жилищное законодательство основывается на необходимости обеспечения органами государственной власти и местного самоуправления условий для осуществления гражданами права на жилище, его безопасности и неприкосновенности.', 
             source_url, full_name),
            ('GK_ZH', '30', 'Права и обязанности собственника жилого помещения',
             'Собственник жилого помещения осуществляет права владения, пользования и распоряжения принадлежащим ему жилым помещением в соответствии с его назначением.', 
             source_url, full_name)
        ]
    
    return []
