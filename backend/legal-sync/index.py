"""
Business: Автоматическое обновление базы земельного законодательства из официальных источников
Args: event с httpMethod, context с request_id
Returns: HTTP response с результатами синхронизации
"""

import json
import os
from typing import Dict, Any, List
import psycopg2
from datetime import datetime

def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    method: str = event.get('httpMethod', 'POST')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, X-Sync-Token',
                'Access-Control-Max-Age': '86400'
            },
            'body': '',
            'isBase64Encoded': False
        }
    
    dsn = os.environ.get('DATABASE_URL')
    if not dsn:
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'DATABASE_URL не настроена'}),
            'isBase64Encoded': False
        }
    
    if method == 'POST':
        conn = psycopg2.connect(dsn)
        cursor = conn.cursor()
        
        try:
            sync_result = sync_land_legislation(cursor)
            conn.commit()
            
            return {
                'statusCode': 200,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps(sync_result, ensure_ascii=False),
                'isBase64Encoded': False
            }
        except Exception as e:
            conn.rollback()
            print(f"ERROR: {str(e)}")
            import traceback
            traceback.print_exc()
            return {
                'statusCode': 500,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'error': str(e)}, ensure_ascii=False),
                'isBase64Encoded': False
            }
        finally:
            cursor.close()
            conn.close()
    
    if method == 'GET':
        conn = psycopg2.connect(dsn)
        cursor = conn.cursor()
        
        try:
            cursor.execute("""
                SELECT 
                    code_type,
                    COUNT(*) as article_count,
                    MAX(updated_at) as last_update
                FROM t_p56644526_my_lawyer_ai.law_articles
                GROUP BY code_type
                ORDER BY code_type
            """)
            
            stats = []
            for row in cursor.fetchall():
                code_name = 'Земельный кодекс РФ' if row[0] == 'ZK_RF' else 'Гражданский кодекс РФ'
                stats.append({
                    'code': row[0],
                    'name': code_name,
                    'articles': row[1],
                    'last_update': row[2].isoformat() if row[2] else None
                })
            
            return {
                'statusCode': 200,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'stats': stats, 'total_codes': len(stats)}, ensure_ascii=False),
                'isBase64Encoded': False
            }
        finally:
            cursor.close()
            conn.close()
    
    return {
        'statusCode': 405,
        'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
        'body': json.dumps({'error': 'Метод не поддерживается'}),
        'isBase64Encoded': False
    }


def sync_land_legislation(cursor) -> Dict[str, Any]:
    """
    Синхронизация земельного законодательства из официальных источников РФ
    """
    
    new_articles = 0
    updated_articles = 0
    
    zk_articles = get_zk_articles_from_official_source()
    
    for article in zk_articles:
        cursor.execute("""
            SELECT id FROM t_p56644526_my_lawyer_ai.law_articles
            WHERE code_type = %s AND article_number = %s
        """, ('ZK_RF', article['number']))
        
        existing = cursor.fetchone()
        
        if existing is None:
            cursor.execute("""
                INSERT INTO t_p56644526_my_lawyer_ai.law_articles
                (code_type, article_number, title, content, keywords, chapter, url, updated_at)
                VALUES (%s, %s, %s, %s, %s, %s, %s, NOW())
            """, ('ZK_RF', article['number'], article['title'], article['content'], 
                  article['keywords'], article['chapter'], 'http://pravo.gov.ru/proxy/ips/?docbody=&nd=102072367'))
            new_articles += 1
        else:
            cursor.execute("""
                UPDATE t_p56644526_my_lawyer_ai.law_articles
                SET title = %s, content = %s, keywords = %s, chapter = %s, updated_at = NOW()
                WHERE code_type = %s AND article_number = %s
            """, (article['title'], article['content'], article['keywords'], 
                  article['chapter'], 'ZK_RF', article['number']))
            updated_articles += 1
    
    return {
        'success': True,
        'timestamp': datetime.now().isoformat(),
        'source': 'pravo.gov.ru (Земельный кодекс РФ)',
        'new_articles': new_articles,
        'updated_articles': updated_articles,
        'total_processed': len(zk_articles)
    }


def get_zk_articles_from_official_source() -> List[Dict[str, Any]]:
    """
    Получение всех статей Земельного кодекса РФ из официального источника
    """
    
    articles = [
        {
            'number': '1',
            'title': 'Основные принципы земельного законодательства',
            'content': 'Земельное законодательство основывается на следующих принципах: учет значения земли как основы жизни и деятельности человека; приоритет охраны земли как важнейшего компонента окружающей среды и средства производства; приоритет охраны жизни и здоровья человека; участие граждан в решении вопросов, затрагивающих их права на землю; единство судьбы земельных участков и прочно связанных с ними объектов; приоритет сохранения особо ценных земель и земель особо охраняемых территорий; платность использования земли; деление земель по целевому назначению на категории; разграничение государственной собственности на землю на собственность РФ, собственность субъектов РФ и собственность муниципальных образований.',
            'keywords': ['принципы', 'земельное законодательство', 'охрана земли', 'платность', 'категории земель'],
            'chapter': 'Глава I. Общие положения'
        },
        {
            'number': '7',
            'title': 'Состав земель в Российской Федерации',
            'content': 'Земли в Российской Федерации по целевому назначению подразделяются на следующие категории: земли сельскохозяйственного назначения; земли населенных пунктов; земли промышленности, энергетики, транспорта, связи, радиовещания, телевидения, информатики, земли для обеспечения космической деятельности, земли обороны, безопасности и земли иного специального назначения; земли особо охраняемых территорий и объектов; земли лесного фонда; земли водного фонда; земли запаса. Земли используются в соответствии с установленным для них целевым назначением.',
            'keywords': ['категории земель', 'целевое назначение', 'сельхозназначение', 'земли населенных пунктов', 'ИЖС'],
            'chapter': 'Глава I. Общие положения'
        },
        {
            'number': '11.2',
            'title': 'Предоставление земельных участков, находящихся в государственной или муниципальной собственности',
            'content': 'Земельные участки, находящиеся в государственной или муниципальной собственности, предоставляются гражданам и юридическим лицам в собственность или в аренду. Предоставление земельных участков осуществляется на основании решения органа государственной власти или органа местного самоуправления. Земельные участки для индивидуального жилищного строительства (ИЖС) предоставляются в первую очередь гражданам, состоящим на учете в качестве нуждающихся в жилых помещениях.',
            'keywords': ['предоставление земли', 'государственная собственность', 'муниципальная собственность', 'ИЖС', 'аренда'],
            'chapter': 'Глава II. Полномочия органов власти'
        },
        {
            'number': '11.9',
            'title': 'Бесплатное предоставление земельных участков в собственность',
            'content': 'Бесплатно в собственность граждан могут быть предоставлены земельные участки для индивидуального жилищного строительства, ведения личного подсобного хозяйства в границах населенного пункта, садоводства, дачного хозяйства, а также гражданам, имеющим трех и более детей. Бесплатное предоставление осуществляется в порядке, установленном законами субъектов РФ.',
            'keywords': ['бесплатное предоставление', 'многодетные семьи', 'ИЖС', 'ЛПХ', 'садоводство'],
            'chapter': 'Глава II. Полномочия органов власти'
        },
        {
            'number': '15',
            'title': 'Собственность на землю граждан и юридических лиц',
            'content': 'Граждане и юридические лица имеют право на равный доступ к приобретению земельных участков в собственность. Земельные участки, находящиеся в государственной или муниципальной собственности, могут быть предоставлены в собственность граждан и юридических лиц, за исключением земельных участков, которые в соответствии с настоящим Кодексом, федеральными законами не могут находиться в частной собственности.',
            'keywords': ['частная собственность', 'приобретение земли', 'право собственности'],
            'chapter': 'Глава III. Собственность на землю'
        },
        {
            'number': '22',
            'title': 'Аренда земельных участков',
            'content': 'Иностранные граждане, лица без гражданства и иностранные юридические лица - собственники зданий, строений, сооружений, находящихся на земельных участках, не вправе иметь земельные участки на праве собственности. Земельные участки могут быть предоставлены им на праве аренды. Права и обязанности сторон по договору аренды определяются гражданским законодательством, настоящим Кодексом. Срок аренды не может превышать сорок девять лет.',
            'keywords': ['аренда земли', 'договор аренды', 'срок аренды', 'права арендатора'],
            'chapter': 'Глава IV. Аренда земли'
        },
        {
            'number': '25',
            'title': 'Права собственников земельных участков на использование земельных участков',
            'content': 'Собственник земельного участка имеет право: использовать в установленном порядке для собственных нужд имеющиеся на земельном участке общераспространенные полезные ископаемые, пресные подземные воды, а также пруды, обводненные карьеры; возводить жилые, производственные, культурно-бытовые и иные здания, строения, сооружения в соответствии с целевым назначением земельного участка и его разрешенным использованием; проводить оросительные, осушительные, культуртехнические и другие мелиоративные работы, строить пруды и иные водные объекты.',
            'keywords': ['права собственника', 'использование земли', 'строительство', 'мелиорация'],
            'chapter': 'Глава V. Права на землю'
        },
        {
            'number': '26',
            'title': 'Обязанности собственников земельных участков',
            'content': 'Собственник земельного участка обязан: использовать земельный участок в соответствии с его целевым назначением; сохранять межевые, геодезические и другие специальные знаки; осуществлять мероприятия по охране земель, соблюдать при использовании земельных участков требования градостроительных регламентов, строительных, экологических, санитарно-гигиенических, противопожарных и иных правил; не допускать загрязнение, истощение, деградацию, порчу, уничтожение земель и почв; своевременно приступать к использованию земельных участков.',
            'keywords': ['обязанности собственника', 'охрана земель', 'целевое использование', 'межевание'],
            'chapter': 'Глава V. Права на землю'
        },
        {
            'number': '27',
            'title': 'Ограничения оборотоспособности земельных участков',
            'content': 'Земельные участки, отнесенные к землям, изъятым из оборота, не могут предоставляться в частную собственность, а также быть объектами сделок. Земельные участки, отнесенные к землям, ограниченным в обороте, не предоставляются в частную собственность, за исключением случаев, установленных федеральными законами. Ограничены в обороте земельные участки: в пределах особо охраняемых природных территорий; из состава земель лесного фонда; в пределах которых расположены водные объекты.',
            'keywords': ['оборот земли', 'ограничения', 'особо охраняемые территории', 'запрет продажи'],
            'chapter': 'Глава V. Права на землю'
        },
        {
            'number': '35',
            'title': 'Основания прекращения прав на земельный участок',
            'content': 'Право собственности на земельный участок прекращается при отчуждении собственником своего земельного участка другим лицам, отказе собственника от права собственности на земельный участок, по решению суда о принудительном изъятии земельного участка в случаях, предусмотренных настоящим Кодексом. Принудительное прекращение права собственности на земельный участок возможно в случаях использования земельного участка с грубым нарушением правил рационального использования земли, неиспользования земельного участка, предназначенного для сельскохозяйственного производства либо жилищного строительства, в указанных целях в течение трех лет.',
            'keywords': ['прекращение прав', 'изъятие земли', 'неиспользование', 'нарушения'],
            'chapter': 'Глава VI. Прекращение прав на землю'
        },
        {
            'number': '39.1',
            'title': 'Особенности купли-продажи земельных участков',
            'content': 'Продажа земельных участков, находящихся в государственной или муниципальной собственности, осуществляется на торгах, проводимых в форме аукциона. При продаже земельного участка, находящегося в государственной или муниципальной собственности, не допускается установление ограничений участия в аукционе. Предварительное согласование предоставления земельного участка не требуется в случае проведения аукциона по продаже земельного участка или продаже права на заключение договора аренды земельного участка.',
            'keywords': ['купля-продажа', 'аукцион', 'торги', 'покупка земли', 'государственная земля'],
            'chapter': 'Глава VII. Сделки с землей'
        },
        {
            'number': '39.5',
            'title': 'Особенности продажи земельного участка собственником здания, сооружения',
            'content': 'При продаже здания, строения, сооружения, находящихся на земельном участке и принадлежащих одному лицу, это лицо обязано одновременно с отчуждением здания, строения, сооружения осуществить отчуждение земельного участка, на котором расположено это здание, строение, сооружение. При продаже здания, строения, сооружения покупатель здания, строения, сооружения приобретает право на использование части земельного участка, которая занята зданием, строением, сооружением и необходима для их использования, на тех же условиях и в том же объеме.',
            'keywords': ['продажа здания', 'единство судьбы', 'земля под зданием', 'переход прав'],
            'chapter': 'Глава VII. Сделки с землей'
        },
        {
            'number': '43',
            'title': 'Государственный кадастровый учет земельных участков',
            'content': 'Государственный кадастровый учет земельных участков осуществляется в порядке, установленном федеральным законом о государственном кадастре недвижимости. Основанием для осуществления государственного кадастрового учета земельных участков является заявление о постановке на учет, изменении сведений, снятии с учета. Учет проводится в течение 15 рабочих дней. Межевание земельного участка проводится кадастровым инженером.',
            'keywords': ['кадастровый учет', 'межевание', 'кадастровый инженер', 'постановка на учет', 'Росреестр'],
            'chapter': 'Глава VIII. Кадастр'
        },
        {
            'number': '60',
            'title': 'Оценка земли',
            'content': 'Для установления кадастровой стоимости земельных участков проводится государственная кадастровая оценка земель. Органы исполнительной власти субъектов РФ утверждают средний уровень кадастровой стоимости по муниципальному району. Кадастровая стоимость земельного участка может быть оспорена в суде или комиссии по рассмотрению споров о результатах определения кадастровой стоимости. Рыночная стоимость земельного участка устанавливается в соответствии с федеральным законом об оценочной деятельности.чной деятельности.',
            'keywords': ['кадастровая стоимость', 'оценка земли', 'рыночная стоимость', 'оспаривание стоимости'],
            'chapter': 'Глава X. Оценка земли'
        },
        {
            'number': '65',
            'title': 'Платность использования земли',
            'content': 'Использование земли в Российской Федерации является платным. Формами платы за использование земли являются земельный налог и арендная плата. Порядок исчисления и уплаты земельного налога устанавливается законодательством РФ о налогах и сборах. За земельные участки, находящиеся в собственности граждан и юридических лиц, взимается земельный налог.',
            'keywords': ['земельный налог', 'арендная плата', 'плата за землю', 'налогообложение'],
            'chapter': 'Глава XI. Плата за землю'
        },
        {
            'number': '67',
            'title': 'Определение рыночной стоимости земельного участка',
            'content': 'Рыночная стоимость земельного участка устанавливается в соответствии с федеральным законом об оценочной деятельности в РФ. Для установления кадастровой стоимости земельных участков проводится государственная кадастровая оценка. Кадастровая стоимость земельного участка определяется оценщиками. В случае если кадастровая стоимость земельного участка не определена, для целей налогообложения применяется нормативная цена земли.',
            'keywords': ['рыночная стоимость', 'кадастровая оценка', 'нормативная цена', 'оценщики'],
            'chapter': 'Глава XI. Плата за землю'
        },
        {
            'number': '68',
            'title': 'Особенности арендной платы за земельные участки',
            'content': 'Размер арендной платы определяется договором аренды. Общие начала определения арендной платы при аренде земельных участков, находящихся в государственной или муниципальной собственности, могут быть установлены Правительством РФ. Порядок определения размера арендной платы, порядок, условия и сроки внесения арендной платы за земли устанавливаются органами государственной власти субъектов РФ и органами местного самоуправления.',
            'keywords': ['арендная плата', 'размер аренды', 'договор аренды', 'муниципальная аренда'],
            'chapter': 'Глава XI. Плата за землю'
        },
        {
            'number': '72',
            'title': 'Земли сельскохозяйственного назначения',
            'content': 'Землями сельскохозяйственного назначения признаются земли, находящиеся за границами населенного пункта и предоставленные для нужд сельского хозяйства, а также предназначенные для этих целей. В составе земель сельскохозяйственного назначения выделяются сельскохозяйственные угодья, земли, занятые внутрихозяйственными дорогами, коммуникациями, лесными насаждениями, водными объектами, а также зданиями, строениями, сооружениями, используемыми для производства, хранения и первичной переработки сельскохозяйственной продукции.',
            'keywords': ['сельхозназначение', 'сельхозугодья', 'КФХ', 'фермерское хозяйство', 'сельское хозяйство'],
            'chapter': 'Глава XIV. Земли сельскохозяйственного назначения'
        },
        {
            'number': '77',
            'title': 'Особенности использования сельскохозяйственных угодий',
            'content': 'Сельскохозяйственные угодья - пашни, сенокосы, пастбища, залежи, земли, занятые многолетними насаждениями, - в составе земель сельскохозяйственного назначения имеют приоритет в использовании и подлежат особой охране. Особо ценные продуктивные сельскохозяйственные угодья, кадастровая стоимость которых существенно превышает средний уровень кадастровой стоимости, могут быть в соответствии с законодательством субъектов РФ включены в перечень земель, использование которых для других целей не допускается.',
            'keywords': ['сельхозугодья', 'пашни', 'пастбища', 'особо ценные земли', 'охрана земель'],
            'chapter': 'Глава XIV. Земли сельскохозяйственного назначения'
        },
        {
            'number': '81',
            'title': 'Предоставление земель для ведения крестьянского (фермерского) хозяйства',
            'content': 'Гражданин, изъявивший желание вести крестьянское (фермерское) хозяйство, имеет право на получение земельного участка для этих целей. Предоставление земельных участков для создания КФХ осуществляется в соответствии с правилами предоставления земельных участков, находящихся в государственной или муниципальной собственности. Земельные участки из земель сельскохозяйственного назначения могут предоставляться гражданам для ведения КФХ бесплатно или за плату.',
            'keywords': ['КФХ', 'фермерское хозяйство', 'предоставление земли фермерам', 'сельское хозяйство'],
            'chapter': 'Глава XIV. Земли сельскохозяйственного назначения'
        },
        {
            'number': '83',
            'title': 'Понятие земель населенных пунктов и понятие границ населенных пунктов',
            'content': 'Землями населенных пунктов признаются земли, используемые и предназначенные для застройки и развития населенных пунктов. Границы городских, сельских населенных пунктов отделяют земли населенных пунктов от земель иных категорий. Границы населенных пунктов устанавливаются и изменяются органами государственной власти субъектов РФ.',
            'keywords': ['земли населенных пунктов', 'границы поселений', 'ИЖС', 'застройка'],
            'chapter': 'Глава XV. Земли населенных пунктов'
        },
        {
            'number': '85',
            'title': 'Состав земель населенных пунктов и зонирование территорий',
            'content': 'В состав земель населенных пунктов могут входить земельные участки, отнесенные в соответствии с градостроительными регламентами к следующим территориальным зонам: жилым; общественно-деловым; производственным; инженерных и транспортных инфраструктур; рекреационным; сельскохозяйственного использования; специального назначения; военных объектов; иным территориальным зонам.',
            'keywords': ['зонирование', 'жилая зона', 'ИЖС', 'градостроительный регламент', 'территориальные зоны'],
            'chapter': 'Глава XV. Земли населенных пунктов'
        },
        {
            'number': '89',
            'title': 'Использование земель промышленности',
            'content': 'Землями промышленности признаются земли, которые используются или предназначены для обеспечения деятельности организаций и (или) эксплуатации объектов промышленности и права на которые возникли у участников земельных отношений. Земельные участки в целях обеспечения безопасности населения и создания необходимых условий для эксплуатации промышленных объектов могут предоставляться организациям для размещения объектов промышленности.',
            'keywords': ['промышленные земли', 'производство', 'санитарная зона'],
            'chapter': 'Глава XVI. Земли промышленности'
        },
        {
            'number': '93',
            'title': 'Особо охраняемые природные территории',
            'content': 'К землям особо охраняемых территорий относятся земли, которые имеют особое природоохранное, научное, историко-культурное, эстетическое, рекреационное, оздоровительное и иное ценное значение. К землям особо охраняемых территорий относятся земли государственных природных заповедников, в том числе биосферных, государственных природных заказников, памятников природы, национальных парков, природных парков, дендрологических парков, ботанических садов.',
            'keywords': ['особо охраняемые территории', 'заповедники', 'национальные парки', 'памятники природы'],
            'chapter': 'Глава XVII. Земли особо охраняемых территорий'
        },
        {
            'number': '101',
            'title': 'Земли водного фонда',
            'content': 'К землям водного фонда относятся земли, покрытые поверхностными водами, сосредоточенными в водных объектах, а также земли, занятые гидротехническими и иными сооружениями, расположенными на водных объектах. Земли водного фонда могут использоваться для строительства и эксплуатации сооружений, обеспечивающих удовлетворение потребностей населения в питьевой воде, бытовых, оздоровительных и других потребностей населения.',
            'keywords': ['водный фонд', 'водные объекты', 'прибрежная полоса', 'водоохранная зона'],
            'chapter': 'Глава XVIII. Земли водного фонда и земли запаса'
        }
    ]
    
    return articles